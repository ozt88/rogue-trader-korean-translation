name: Auto Release on Translation Update

on:
  push:
    branches: [ master ]
    paths:
      - 'enGB_new.json'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Copy enGB_new.json to enGB.json
        run: cp enGB_new.json enGB.json
      
      - name: Get commit info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Generate version tag
        id: version
        run: |
          # Count commits that modified enGB_new.json
          COUNT=$(git log --oneline --follow -- enGB_new.json | wc -l)
          echo "tag=v1.0.${COUNT}" >> $GITHUB_OUTPUT
          echo "name=Translation Update v1.0.${COUNT}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.name }}
          body: |
            ## 변경 사항
            ${{ steps.commit.outputs.message }}
            
            ### 커밋
            - SHA: `${{ steps.commit.outputs.short_sha }}`
            - 날짜: ${{ github.event.head_commit.timestamp }}
            
            ### 설치 방법
            1. `enGB.json` 파일을 다운로드
            2. 게임 설치 폴더의 `Localization` 폴더에 복사
            3. 기존 `enGB.json`을 백업한 후 교체
          files: enGB.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
